## ASLR
地址空间布局随机化（Address Space Layout Randomization，ASLR），内存布局的随机化
在 Linux 上，ASLR 的全局配置 `/proc/sys/kernel/randomize_va_space` 有三种情况：
- `0` 表示关闭 ASLR
- `1` 表示部分开启，将 `mmap` 的基址， `stack` 和 `vdso` 页面随机化，即栈和 `libc` 的地址变化
- `2` 表示完全开启，在部分开启的基础上增加 `heap` 的随机化，即栈、堆和 `libc` 都变化，但程序本身以及 PLT 不变
如下图所示

| ASLR      | Executable | PLT | Heap | Stack | Shared libraries |
| --------- | ---------- | --- | ---- | ----- | ---------------- |
| `0`       | 0          | 0   | 0    | 0     | 0                |
| `1`       | 0          | 0   | 0    | 1     | 1                |
| `2`       | 0          | 0   | 1    | 1     | 1                |
| `2` + PIE | 1          | 1   | 1    | 1     | 1                |
由于 ASLR 是一种操作系统层面的技术，而二进制程序本身不支持随机化加载，便出现了一些绕过方式，如 `ret2plt`、GOT 劫持、地址爆破等
## PIE
位置无关可执行文件（Position-Independent Executable，PIE），它在应用层的 **编译器** 上实现，通过将程序编译为 **位置无关代码（Position-Independent Code，PIC）**，使程序可以被加载到任意位置，可以理解为一个特殊的共享库
但 PIE 在增加安全性的同时，也在一定程度上影响性能
在 PIE 和 ASLR 同时开启的情况下，攻击者将对程序的内存布局一无所知
### GCC 编译选项
| 选项         | 意义                                            |
| ---------- | --------------------------------------------- |
| `-fpic`    | 为共享库生成位置无关代码                                  |
| `-pie`     | 生成动态链接的位置无关可执行文件，通常需要同时指定 `-fpie`             |
| `-no-pie`  | 不生成动态链接的位置无关可执行文件                             |
| `-fpie`    | 类似于 `-fpic`，但生成的位置无关代码只能用于可执行文件，通常同时指定 `-pie` |
| `-fno-pie` | 不生成位置无关代码                                     |
无论是 ASLR 还是 PIE，由于粒度问题，被随机化的都只是 **某个对象的起始地址**，而该对象的 **内部仍保持原来的结构**，即 **相对偏移不变**
